package PkcsTest.CAShare;

import certTest.EnvelopeUtil2;
import certTest.KeyUtil2;
import cn.com.mcsca.pki.core.bouncycastle.asn1.x500.RDN;
import cn.com.mcsca.pki.core.bouncycastle.asn1.x500.X500Name;
import cn.com.mcsca.pki.core.bouncycastle.asn1.x500.style.BCStyle;
import cn.com.mcsca.pki.core.bouncycastle.crypto.CryptoException;
import cn.com.mcsca.pki.core.bouncycastle.crypto.params.ECDomainParameters;
import cn.com.mcsca.pki.core.bouncycastle.crypto.params.ECPrivateKeyParameters;
import cn.com.mcsca.pki.core.bouncycastle.crypto.signers.StandardDSAEncoding;
import cn.com.mcsca.pki.core.bouncycastle.jcajce.provider.asymmetric.ec.BCECPrivateKey;
import cn.com.mcsca.pki.core.bouncycastle.jce.ECNamedCurveTable;
import cn.com.mcsca.pki.core.bouncycastle.jce.provider.BouncyCastleProvider;
import cn.com.mcsca.pki.core.bouncycastle.jce.spec.ECNamedCurveParameterSpec;
import cn.com.mcsca.pki.core.bouncycastle.jce.spec.ECParameterSpec;
import cn.com.mcsca.pki.core.bouncycastle.jce.spec.ECPrivateKeySpec;
import cn.com.mcsca.pki.core.bouncycastle.util.encoders.Base64;
import cn.com.mcsca.pki.core.bouncycastle.util.encoders.Hex;
import cn.com.mcsca.pki.core.util.CertRequestUtil;
import cn.com.mcsca.pki.core.util.CertUtil;
import cn.com.mcsca.pki.core.util.EnvelopeUtil;
import cn.com.mcsca.pki.core.util.KeyUtil;
import cn.com.mcsca.pki.core.util.SignatureUtil;
import cn.com.mcsca.pki.core.x509.X509Certificate;

import javax.crypto.BadPaddingException;
import javax.crypto.Cipher;
import javax.crypto.IllegalBlockSizeException;
import javax.crypto.NoSuchPaddingException;
import javax.crypto.SecretKey;
import javax.crypto.spec.SecretKeySpec;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.math.BigInteger;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.security.InvalidKeyException;
import java.security.Key;
import java.security.KeyFactory;
import java.security.KeyPair;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.cert.CertificateEncodingException;
import java.security.spec.InvalidKeySpecException;
import java.security.spec.PKCS8EncodedKeySpec;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * 这里将证书，私钥，全放本地，目录结构：
 * ROOT_PATH/
 * ├── PRI/
 * │   └── PIN.key
 * └── certs/
 * x   ├── SINGLE,SN1/
 * x   │   └── SN1.cer
 * x   └── DOUBLE,SN2,ENC-SN3/
 * x       ├── SN2.cer
 * x       ├── SN3.key
 * x       └── SN3.cer
 *
 * @author TangHaoKai
 * @version V1.0 2024/8/9 10:21
 */
public class ScapCertificateSource2 {
    private String ROOT_PATH;
    private static final String PRI_FILE_PATH = "PRI\\PIN.key";
    private static final String CERTS_PATH = "CERTS\\";

    public ScapCertificateSource2(String root) {
        ROOT_PATH = root;
    }

    public static void main(String[] args) throws Exception {
        ScapCertificateSource2 scapCertificateSource2 = new ScapCertificateSource2("C:\\Users\\ggk911\\IdeaProjects\\test\\src\\main\\java\\PkcsTest\\CAShare\\");
        // 检查pin码，获取私钥及公钥
        String priAndPub = scapCertificateSource2.checkPinCode("654321", "sm2256");
        System.out.println(String.format("%-16s", "priAndPub>> ") + priAndPub);
        // // 生成P10
        // String p10 = scapCertificateSource2.generateCertReq("sm2256", "654321", "");
        // System.out.println(String.format("%-16s", "p10>> ") + p10);
        // // 导入单证
        // boolean importCertificate = scapCertificateSource2.importCertificate("MIIBnDCCAUKgAwIBAgIJANo/Mi7snWftMAoGCCqBHM9VAYN1MDIxCzAJBgNVBAYTAkNOMQ8wDQYDVQQKEwZNSU5JQ0ExEjAQBgNVBAMTCVJPT1RTTTJDQTAeFw0yNDA4MTIxMDA5MTJaFw0yOTA4MTExMDA5MTJaMBAxDjAMBgNVBAMMBU1DU0NBMFkwEwYHKoZIzj0CAQYIKoEcz1UBgi0DQgAEL1q+0/Fa2cqFrEBo+fQRJzLjG1gTGfv+LWHG/QzHbwV5QC2rr9chlm2KnbySEB7+CUUtERK0SYGvVZEe/BKR0aNjMGEwHQYDVR0OBBYEFBpy6ufKqtgjs7pV7Himb6t/SEqrMB8GA1UdIwQYMBaAFOARhhxjAyGNHIYBJtv7Ye1tQNPqMAsGA1UdDwQEAwIBBjASBgNVHRMBAf8ECDAGAQH/AgEDMAoGCCqBHM9VAYN1A0gAMEUCIGcpt7yrWnjYjpXyp7XjeKKbf1dPfHv+Iopj9uShL43OAiEA4PjcERkfae/fBg1ADJ482KP79tkvm9nPkRz6wU8QvYw=");
        // // boolean importCertificate = scapCertificateSource2.importCertificate("MIICnzCCAkOgAwIBAgIQIzIeSWVPeB+h+6mDDAPO0zAMBggqgRzPVQGDdQUAMC0xCzAJBgNVBAYTAkNOMQ4wDAYDVQQKDAVNQ1NDQTEOMAwGA1UEAwwFTUNTQ0EwHhcNMjQwOTEzMDY1MzU2WhcNMjQxMjIyMDY1MzU2WjB7MQswCQYDVQQGEwJDTjEOMAwGA1UECgwFTUNTQ0ExEDAOBgNVBAsMB2xvY2FsUkExGzAZBgNVBAUMEjUxMDIwMjE5NjcwMzE2NjIxWDEtMCsGA1UEAwwkMTc2NTI0Njg3Mzc4Mzg0NDg2NEDllJDlpb3lh69AMDFAMDE3MFkwEwYHKoZIzj0CAQYIKoEcz1UBgi0DQgAEDVHiOvsmxtNUYJuNsQVqj4I7sEOm1uXRUwkWfZrzGps6c+MwhtLUwaVgS1VY2wdv7znNwCpcAUOQ76W7t86fBqOB9DCB8TAfBgNVHSMEGDAWgBTxIgpnmI3147KqwxdrwEIfvku9djAdBgNVHQ4EFgQU6QycUapswFj0sG096GwDo0tsCmgwRAYDVR0gBD0wOzA5BgcqgRyHhAsBMC4wLAYIKwYBBQUHAgEWIGh0dHBzOi8vd3d3Lm1jc2NhLmNvbS5jbi9jcHMuaHRtMAsGA1UdDwQEAwIE8DBcBggrBgEFBQcBAQRQME4wKAYIKwYBBQUHMAKGHGh0dHA6Ly8xMjcuMC4wLjEvY2Fpc3N1ZS5odG0wIgYIKwYBBQUHMAGGFmh0dHA6Ly8xMjcuMC4wLjE6MjA0NDMwDAYIKoEcz1UBg3UFAANIADBFAiAbyZYtO8EpV6bEqYZtP7ZVee/qDha+SonvRif7QCSVcwIhAKqqVNAkHJvfVvXu+y5Ax3+8/ZN4E20Xf9ekwXDxBYDw");
        // System.out.println(String.format("%-16s", "importCertificate>> ") + importCertificate);
        // 导入双证
        // boolean importDoubleCertificate = scapCertificateSource2.importDoubleCertificate("MIICsDCCAlOgAwIBAgIQGOjscdxYHn/RySLkMEHObjAMBggqgRzPVQGDdQUAMC0xCzAJBgNVBAYTAkNOMQ4wDAYDVQQKDAVNQ1NDQTEOMAwGA1UEAwwFTUNTQ0EwHhcNMjQxMTA4MDYxNjU0WhcNMjUxMTA4MDYxNjU0WjBiMQswCQYDVQQGEwJDTjEjMCEGCSqGSIb3DQEJARYUemhhbmdzYW5AZXhhbXBsZS5jb20xLjAsBgNVBAMMJTEyMzQ1NkDlvKDkuIlAMDUyMjEyMTIwMDEwMzIxNjIxNkAwMDIwWTATBgcqhkjOPQIBBggqgRzPVQGCLQNCAAQNUeI6+ybG01Rgm42xBWqPgjuwQ6bW5dFTCRZ9mvMamzpz4zCG0tTBpWBLVVjbB2/vOc3AKlwBQ5Dvpbu3zp8Go4IBHDCCARgwCwYDVR0PBAQDAgTwMAwGA1UdEwQFMAMBAQAwHwYDVR0jBBgwFoAU8SIKZ5iN9eOyqsMXa8BCH75LvXYwHQYDVR0OBBYEFOkMnFGqbMBY9LBtPehsA6NLbApoMIG6BgNVHR8EgbIwga8wLqAsoCqGKGh0dHA6Ly93d3cubWNzY2EuY29tLmNuL3NtMi9jcmwvY3JsMC5jcmwwfaB7oHmGd2xkYXA6Ly93d3cubWNzY2EuY29tLmNuOjM4OS9DTj1jcmwwLE9VPUNSTCxPPU1DU0NBLEM9Q04/Y2VydGlmaWNhdGVSZXZvY2F0aW9uTGlzdD9iYXNlP29iamVjdGNsYXNzPWNSTERpc3RyaWJ1dGlvblBvaW50MAwGCCqBHM9VAYN1BQADSQAwRgIhAMDAW6xDWH7i/ekgyP1YFi9KnoOVWPbBPiv4SokJS8MQAiEA3SlB30S3FcKoFY6Vv3PIXKrySEp29LTE0tZm8lO75Zs=", "MIIDIjCCAsagAwIBAgIQEpIBeZCN0uVFycVjcWugfzAMBggqgRzPVQGDdQUAMC0xCzAJBgNVBAYTAkNOMQ4wDAYDVQQKDAVNQ1NDQTEOMAwGA1UEAwwFTUNTQ0EwHhcNMjQxMTA4MDYxNjU0WhcNMjUxMTA4MDYxNjU0WjBiMQswCQYDVQQGEwJDTjEjMCEGCSqGSIb3DQEJARYUemhhbmdzYW5AZXhhbXBsZS5jb20xLjAsBgNVBAMMJTEyMzQ1NkDlvKDkuIlAMDUyMjEyMTIwMDEwMzIxNjIxNkAwMDIwWTATBgcqhkjOPQIBBggqgRzPVQGCLQNCAATrun36aDlRQ5JDxdHUoUrQ04kOiQf7dhKshZNgUn71T2NnV8E4UqAQ/t4g64EG3xRyVmi5TDHD+zEcpuKK2vV7o4IBjzCCAYswDAYDVR0TBAUwAwEBADAdBgNVHQ4EFgQUlLpGuk+IDc2gR1Kc+81JLWsLxQgwgboGA1UdHwSBsjCBrzAuoCygKoYoaHR0cDovL3d3dy5tY3NjYS5jb20uY24vc20yL2NybC9jcmwwLmNybDB9oHugeYZ3bGRhcDovL3d3dy5tY3NjYS5jb20uY246Mzg5L0NOPWNybDAsT1U9Q1JMLE89TUNTQ0EsQz1DTj9jZXJ0aWZpY2F0ZVJldm9jYXRpb25MaXN0P2Jhc2U/b2JqZWN0Y2xhc3M9Y1JMRGlzdHJpYnV0aW9uUG9pbnQwCwYDVR0PBAQDAgQwMBMGA1UdJQQMMAoGCCsGAQUFBwMBMFwGCCsGAQUFBwEBBFAwTjAoBggrBgEFBQcwAoYcaHR0cDovLzEyNy4wLjAuMS9jYWlzc3VlLmh0bTAiBggrBgEFBQcwAYYWaHR0cDovLzEyNy4wLjAuMToyMDQ0MzAfBgNVHSMEGDAWgBTxIgpnmI3147KqwxdrwEIfvku9djAMBggqgRzPVQGDdQUAA0gAMEUCIQDClVyQw9Q9ughxu1JNhGS7YJ9k4eAr2siKbVH82ypm4AIgbEeQMyiYC9138EMWC2/u7IfKg1wLIIVaa3zkdiu1Fnc=", "MIHwMAwGCCqBHM9VAWgBBQAweQIhAJyoiE1L0yv5v3CDfz5pnhq8oED9gavHl1IbvKQ7/h9AAiA8G6ERKv/AMz3iv5cKYG9LCGhElPyVR2QaiHFm52Q7ZAQgH25RZ3gQvWScVlLdZ+Nb191rlH3RMrWrUBNEJO/Ms3cEEAGK1QCXNZzT0ftTZtXCeWcDQgAE67p9+mg5UUOSQ8XR1KFK0NOJDokH+3YSrIWTYFJ+9U9jZ1fBOFKgEP7eIOuBBt8UclZouUwxw/sxHKbiitr1ewMhANEo2IAtoEbR+HJgWXmsl5tsNDfaDY5eOCP8L7nhGIq+");
        // System.out.println(String.format("%-16s", "importDoubleCertificate>> ") + importDoubleCertificate);;
        // // 解析证书
        // Map<String, Object> parseCert = scapCertificateSource2.parseCertificateBase64("MIIDOjCCAiKgAwIBAgIJAP2hKvUlbXVOMA0GCSqGSIb3DQEBCwUAMDIxCzAJBgNVBAYTAkNOMQ8wDQYDVQQKEwZNSU5JQ0ExEjAQBgNVBAMTCVJPT1RSU0FDQTAeFw0yNDA3MTMwODA4MDBaFw0yOTA3MTIwODA4MDBaMCIxDzANBgNVBAYTBk1JTklDQTEPMA0GA1UEAxMGZ2drOTExMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2rodmJjz0cW0t1db7wKJNBVQ+FJ1V5+GFCxWlGZp8rqJaLmlLK9gfaEELB4tP9UR3AOfQPawaLho6Qi9pDArHk501hF7kX+BHVY5djcVWfJWSOerwhOE2FaMzi/B2H9Basq5rxsra1JNuXJYXwB3ItbGNMyU9oy5LjKZHIRIBqjvtwfpcimag4UZnAbwbDJGKqDnkPbAeJd0ApI3DU6fJXmGJGJAyKZglQLZenqGiNfcLv45RT77mbDh2GgPX/TB5Xb9skC7yPte1JHA0HuY7J/cyo1nsTAZvnJhZLlurxbyunUaHMIxkGqMJAQEFbpcrRwRU7GQUn0w+GLqsugjxwIDAQABo2MwYTAdBgNVHQ4EFgQUp3AmIb6m5tX43iFXbC9Geoh3NsAwHwYDVR0jBBgwFoAUCXbWaz4Ac7IoLrfrDN8vVwuITeQwCwYDVR0PBAQDAgEGMBIGA1UdEwEB/wQIMAYBAf8CAQMwDQYJKoZIhvcNAQELBQADggEBAHHIlaNDpt7wsaayTAfAMTphoigkL01YLFZLZbEoaOAJJDv/S9o/1mCSIdSfnK81H9lyz/hzfRXtCdTMhVHPxHxustif+o3xOcf0K1xvT8l4r2nhFiXjdH69j5ie9Jy13BgywccLW64h3ybE7fbEIlOI0KehzrdYd+jHn3gCs3WNKJQWfaz40kdTTccjWUzzYMmn7FAFTFXjmzoTvT3krKmbDyD+Ne36aw3k1Saw6cqkYQu5hXibbkYGsZz4vVurPnQwKmAV/PJEwJrsS09L4bCRQvR7oPmvmNV5Gd/azj+/qVh6YzZyWKMaPJAAoyZZ1jGKQyA2YNXd3r1AVRnqmO8=");
        // 获取所有证书SN
        // List<String> certificatesSns = scapCertificateSource2.getCertificatesSn();
        // System.out.println(String.format("%-16s", "allSN>> ") + String.join(",", certificatesSns));
        // // 修改pin码
        // // scapCertificateSource2.changePassword("654321", "654321", "");
        // System.out.println(String.format("%-16s", "allcerts>> ") + String.join(",", scapCertificateSource2.getCertificates()));
        // 获取单个证书
        Map<String, Object> certificateWithSn = scapCertificateSource2.getCertificateWithSn("18E8EC71DC581E7FD1C922E43041CE6E");
        System.out.println(String.format("%-16s", "issuerDN>> ") + certificateWithSn.get("issuerDN"));
        System.out.println(String.format("%-16s", "notBefore>> ") + certificateWithSn.get("notBefore"));
        System.out.println(String.format("%-16s", "notAfter>> ") + certificateWithSn.get("notAfter"));
        System.out.println(String.format("%-16s", "subjectDN>> ") + certificateWithSn.get("subjectDN"));
        // 签名
        // String sighType = "SIGN_PKCS7_D";
        // String sign = scapCertificateSource2.signMessage("654321", "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".getBytes(StandardCharsets.UTF_8), "HASH_SM3", sighType, String.valueOf(certificateWithSn.get("certBase64")));
        // System.out.println(String.format("%-16s", "SIGN_PKCS7_D>> ") + sign);
        // sighType = "SIGN_PKCS1";
        // sign = scapCertificateSource2.signMessage("654321", Base64.decode("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"), "HASH_SM3", sighType, String.valueOf(certificateWithSn.get("certBase64")));
        // // sign = scapCertificateSource2.signMessage("654321", "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".getBytes(StandardCharsets.UTF_8), "HASH_SM3", sighType, String.valueOf(certificateWithSn.get("certBase64")));
        // System.out.println(String.format("%-16s", "SIGN_PKCS1>> ") + sign);
        // 封装数字信封
        String envelopeEncryptMessage = scapCertificateSource2.envelopeEncryptMessage("123321456654".getBytes(StandardCharsets.UTF_8), String.valueOf(certificateWithSn.get("certBase64")), null);
        System.out.println(String.format("%-16s", "Envelop>> ") + envelopeEncryptMessage);
        // 解密数字信封
        byte[] envelopeDecryptMessage = scapCertificateSource2.envelopeDecryptMessage2("654321", envelopeEncryptMessage, String.valueOf(certificateWithSn.get("certBase64")));
        String decEnvelop = new String(envelopeDecryptMessage, StandardCharsets.UTF_8);
        System.out.println(String.format("%-16s", "decEnvelop>> ") + decEnvelop);
        // // 裸签
        // String signHash = scapCertificateSource2.signHash("654321", Hex.decode("d77baa524888f0bc9706a850c35de891e61d281e3039939c72ae52b781d37431"), "HASH_SM3", "SIGN_PKCS1", String.valueOf(certificateWithSn.get("certBase64")));
        // System.out.println(String.format("%-16s", "signHash>> ") + signHash);
        // // 通过SN找KEY
        // String key = scapCertificateSource2.getCertPriKeyWithSn("3BC1772AF945115771FC0AD61396C52A", "654321");
        // System.out.println(String.format("%-16s", "key>> ") + key);

    }

    /**
     * 生成p10
     */
    public String generateCertReq(String certType, String pin, String certSys) {
        // 单双 这里对于我们来说单双都不影响，只是cfca这里是特殊的P10，先不管
        // 这里肯定是拿pin取私钥，私钥生成P10
        if ("SINGLE".equals(certSys)) {

        } else {

        }
        // 检查pin
        String priAndPub;
        try {
            priAndPub = checkPinCode(pin, certType);
            if (priAndPub.isEmpty()) {
                throw new RuntimeException("验证pin失败");
            }
        } catch (IOException e) {
            throw new RuntimeException("检查pin文件异常" + e.getMessage());
        }
        // 证书类型
        try {
            byte[] p10Bytes = genP10(priAndPub);
            return Base64.toBase64String(p10Bytes);
        } catch (NoSuchAlgorithmException | InvalidKeySpecException | IOException e) {
            throw new RuntimeException("生成P10异常" + e.getMessage());
        }
    }

    /**
     * 导入单证
     */
    public boolean importCertificate(String strCert) {
        X509Certificate cert = new X509Certificate(Base64.decode(strCert));
        String sn = cert.getSerialNumber().toString(16).toUpperCase();
        checkCertsDir();
        checkRepeatCert(sn);
        File cerDir = new File(ROOT_PATH + CERTS_PATH, "SINGLE," + sn);
        if (!cerDir.mkdir()) {
            throw new RuntimeException("创建证书文件目录失败" + sn);
        } else {
            File cerFile = new File(cerDir, sn + ".cer");
            try {
                write(cerFile.getParentFile(), cerFile.getName(), Base64.decode(strCert));
            } catch (Exception e) {
                throw new RuntimeException("保存证书文件失败" + e.getMessage());
            }
            return true;
        }
    }

    /**
     * 导入双证
     */
    public boolean importDoubleCertificate(String strSignCert, String strEncryptCert, String strPri) {
        X509Certificate cert = new X509Certificate(Base64.decode(strSignCert));
        X509Certificate encX509Cert = new X509Certificate(Base64.decode(strEncryptCert));
        String sn = cert.getSerialNumber().toString(16).toUpperCase();
        String encSn = encX509Cert.getSerialNumber().toString(16).toUpperCase();
        checkCertsDir();
        checkRepeatCert(sn);
        File cerDir = new File(ROOT_PATH + CERTS_PATH, "DOUBLE," + sn + "," + encSn);
        if (!cerDir.mkdir()) {
            throw new RuntimeException("创建证书文件目录失败" + sn);
        } else {
            try {
                File cerFile = new File(cerDir, sn + ".cer");
                write(cerFile.getParentFile(), cerFile.getName(), Base64.decode(strSignCert));
                X509Certificate encCert = new X509Certificate(Base64.decode(strEncryptCert));
                String encCertSn = encCert.getSerialNumber().toString(16).toUpperCase();
                File encCerFile = new File(cerDir, encCertSn + ".cer");
                write(encCerFile.getParentFile(), encCerFile.getName(), Base64.decode(strEncryptCert));
                File encKeyFile = new File(cerDir, encCertSn + ".key");
                write(encKeyFile.getParentFile(), encKeyFile.getName(), Base64.decode(strPri));
            } catch (Exception e) {
                throw new RuntimeException("保存证书文件失败" + e.getMessage());
            }
            return true;
        }
    }

    /**
     * 获取所有证书SN
     */
    public List<String> getCertificatesSn() {
        checkCertsDir();
        File cersDir = new File(ROOT_PATH + CERTS_PATH);
        List<String> certSns = new ArrayList<>();
        for (File file : cersDir.listFiles()) {
            if (file.isDirectory() && file.getName().split(",").length == 2) {
                certSns.add(file.getName().split(",")[1]);
            } else if (file.isDirectory() && file.getName().split(",").length == 3) {
                certSns.add(file.getName().split(",")[1]);
                certSns.add(file.getName().split(",")[2]);
            }
        }
        return certSns;
    }

    /**
     * 修改PIN码
     */
    public String changePassword(String oldPin, String newPin, String serialNo) {
        if (updatePinCode(oldPin, newPin)) {
            System.out.println("修改PIN成功");
            // thk's todo 2024/8/12 11:40 这里返回什么？？
            return "true";
        } else {
            return "false";
        }
    }

    /**
     * 获取所有证书
     */
    public List<String> getCertificates() {
        return getAllCerts();
    }

    /**
     * 签名
     */
    public String signMessage(String pinCode, byte[] srcData, String hashType, String signType, String certBase64) {
        String priAndPub;
        try {
            priAndPub = checkPinCode(pinCode, "");
        } catch (IOException e) {
            throw new RuntimeException("PIN验证异常" + e.getMessage());
        }
        String certType = priAndPub.split(",")[0];
        String pri = priAndPub.split(",")[1];
        PrivateKey privateKey;
        try {
            privateKey = certTest.KeyUtil.parsePriKey(pri);
        } catch (NoSuchAlgorithmException | InvalidKeySpecException | IOException e) {
            throw new RuntimeException("私钥转换失败" + e.getMessage());
        }
        String rsaAlg = "SHA256withRSA";
        if (certType.contains("RSA")) {
            if (hashType.equals("HASH_SHA1")) {
                rsaAlg = "SHA1withRSA";
            } else if (hashType.equals("HASH_SHA256")) {
                rsaAlg = "SHA256withRSA";
            } else if (hashType.equals("HASH_SHA384")) {
                rsaAlg = "SHA384withRSA";
            } else if (hashType.equals("HASH_SHA512")) {
                rsaAlg = "SHA512withRSA";
            } else if (hashType.equals("HASH_MD5_SHA1")) {
                rsaAlg = "MD5withRSA";
            } else {
                System.out.println("摘要算法为空，默认SHA256");
            }
        }
        if ("SIGN_PKCS1".equals(signType)) {
            if (certType.equalsIgnoreCase("SM2256")) {
                byte[] p1MessageSign = SignatureUtil.P1MessageSign("SM3WITHSM2", srcData, privateKey);
                return new String(p1MessageSign, StandardCharsets.UTF_8);
            } else if (certType.equalsIgnoreCase("RSA1024") || certType.equalsIgnoreCase("RSA2048")) {
                byte[] p1MessageSign = SignatureUtil.P1MessageSign(rsaAlg, srcData, privateKey);
                return new String(p1MessageSign, StandardCharsets.UTF_8);
            }
        } else if ("SIGN_PKCS7_A".equals(signType)) {
            X509Certificate cert = new X509Certificate(Base64.decode(certBase64));
            if (certType.equalsIgnoreCase("SM2256")) {
                byte[] p7MessageSignAttach = SignatureUtil.P7MessageSignAttach("SM3WITHSM2", srcData, privateKey, cert);
                return new String(p7MessageSignAttach, StandardCharsets.UTF_8);
            } else {
                byte[] p7MessageSignAttach = SignatureUtil.P7MessageSignAttach(rsaAlg, srcData, privateKey, cert);
                return new String(p7MessageSignAttach, StandardCharsets.UTF_8);
            }
        } else if ("SIGN_PKCS7_D".equals(signType)) {
            X509Certificate cert = new X509Certificate(Base64.decode(certBase64));
            if (certType.equalsIgnoreCase("SM2256")) {
                byte[] p7MessageSignDetach = SignatureUtil.P7MessageSignDetach("SM3WITHSM2", srcData, privateKey, cert);
                return new String(p7MessageSignDetach, StandardCharsets.UTF_8);
            } else {
                byte[] p7MessageSignAttach = SignatureUtil.P7MessageSignDetach(rsaAlg, srcData, privateKey, cert);
                return new String(p7MessageSignAttach, StandardCharsets.UTF_8);
            }
        }
        throw new RuntimeException("签名异常");
    }

    /**
     * 裸签
     */
    public String signHash(String pinCode, byte[] hashData, String hashType, String signType, String certBase64) {
        // thk's todo 2024/8/13 10:10 有个问题,这里的hash只针对sm2吗? RSA哪来的直接传hash?
        String priAndPub;
        try {
            priAndPub = checkPinCode(pinCode, "");
        } catch (IOException e) {
            throw new RuntimeException("PIN验证异常" + e.getMessage());
        }
        String certType = priAndPub.split(",")[0];
        String pri = priAndPub.split(",")[1];
        PrivateKey privateKey;
        try {
            privateKey = certTest.KeyUtil2.parsePriKey(pri);
        } catch (NoSuchAlgorithmException | InvalidKeySpecException | IOException e) {
            throw new RuntimeException("私钥转换失败" + e.getMessage());
        }
        String rsaAlg = "SHA256withRSA";
        if (certType.contains("RSA")) {
            if (hashType.equals("HASH_SHA1")) {
                rsaAlg = "SHA1withRSA";
            } else if (hashType.equals("HASH_SHA256")) {
                rsaAlg = "SHA256withRSA";
            } else if (hashType.equals("HASH_SHA384")) {
                rsaAlg = "SHA384withRSA";
            } else if (hashType.equals("HASH_SHA512")) {
                rsaAlg = "SHA512withRSA";
            } else if (hashType.equals("HASH_MD5_SHA1")) {
                rsaAlg = "MD5withRSA";
            } else {
                System.out.println("摘要算法为空，默认SHA256");
            }
        }
        if ("SIGN_PKCS1".equals(signType)) {
            if (certType.equalsIgnoreCase("SM2256")) {
                BCECPrivateKey bcecPrivateKey = (BCECPrivateKey) privateKey;
                ECParameterSpec parameterSpec = bcecPrivateKey.getParameters();
                ECDomainParameters domainParameters = new ECDomainParameters(parameterSpec.getCurve(), parameterSpec.getG(), parameterSpec.getN(), parameterSpec.getH());
                ECPrivateKeyParameters ecPrivateKeyParameters = new ECPrivateKeyParameters(bcecPrivateKey.getD(), domainParameters);

                SM2SignerEx signer = new SM2SignerEx(StandardDSAEncoding.INSTANCE);
                signer.init(true, ecPrivateKeyParameters);
                byte[] p1MessageSign;
                try {
                    p1MessageSign = signer.generateSignature(hashData);
                } catch (CryptoException e) {
                    throw new RuntimeException("hash签名异常" + e.getMessage());
                }
                return Base64.toBase64String(p1MessageSign);
            } else if (certType.equalsIgnoreCase("RSA1024") || certType.equalsIgnoreCase("RSA2048")) {
                byte[] p1MessageSign = SignatureUtil.P1MessageSign(rsaAlg, hashData, privateKey);
                return new String(p1MessageSign, StandardCharsets.UTF_8);
            }
        } else if ("SIGN_PKCS7_A".equals(signType)) {
            // thk's todo 2024/8/13 10:38
        } else if ("SIGN_PKCS7_D".equals(signType)) {
            // thk's todo 2024/8/13 10:39
        }
        throw new RuntimeException("签名异常");
    }

    /**
     * 数字信封加密
     */
    public String envelopeEncryptMessage(byte[] plaintext, String certBase64, String alg) {
        X509Certificate x509Certificate = new X509Certificate(Base64.decode(certBase64));
        System.out.println(String.format("%-16s", "signAlg>> ") + x509Certificate.getSignatureAlgorithmName());
        String asyAlg;
        if ("1.2.156.10197.1.501".equalsIgnoreCase(x509Certificate.getSignatureAlgorithmName())) {
            asyAlg = "SM4CBC";
        } else {
            if (alg.equals("ALG_RC4")) {
                asyAlg = "RC4";
            } else {
                asyAlg = "DESEDECBC";
            }
        }
        X509Certificate[] certificates = new X509Certificate[]{x509Certificate};
        byte[] envelopeMessage = EnvelopeUtil.envelopeMessage(plaintext, asyAlg, certificates);
        return new String(envelopeMessage, StandardCharsets.UTF_8);
    }

    /**
     * 数字信封解密(弃用)
     */
    // public byte[] envelopeDecryptMessage(String pin, String ciphertext, String certBase64) {
    //     // thk's todo 2024/8/13 10:43 解数字信封,这里用msca的结构?? RSA的应该是两段
    //     String priAndPub;
    //     try {
    //         priAndPub = checkPinCode(pin, "");
    //     } catch (IOException e) {
    //         throw new RuntimeException("校验PIN异常" + e.getMessage());
    //     }
    //     String keyType = priAndPub.split(",")[0];
    //     if ("sm2256".equalsIgnoreCase(keyType)) {
    //         String oriTextHex;
    //         try {
    //             oriTextHex = certTest.EnvelopeUtil2.openTheEnvelope(ciphertext, Hex.toHexString(Base64.decode(certBase64)));
    //         } catch (NoSuchAlgorithmException | InvalidKeySpecException | InvalidKeyException | IOException |
    //                  InvalidCipherTextException | NoSuchPaddingException | IllegalBlockSizeException |
    //                  BadPaddingException e) {
    //             throw new RuntimeException("解信封异常" + e.getMessage());
    //         }
    //         return Hex.decode(oriTextHex);
    //     }
    //     throw new RuntimeException("非sm2信封结构");
    // }

    /**
     * 数字信封解密
     */
    public byte[] envelopeDecryptMessage2(String pin, String ciphertext, String certBase64) {
        // thk's todo 2024/8/13 10:43 解数字信封,这里用msca的结构?? RSA的应该是两段
        String priAndPub;
        try {
            priAndPub = checkPinCode(pin, "");
        } catch (IOException e) {
            throw new RuntimeException("校验PIN异常" + e.getMessage());
        }
        // 测试
        if ("sm2256".equalsIgnoreCase(priAndPub.split(",")[0])) {
            String oriTextHex;
            try {
                X509Certificate x509Certificate = new X509Certificate(Base64.decode(certBase64));
                // 判断这里的证书是签名证书还是加密证书，才能去拿哪个私钥
                String sn = x509Certificate.getSerialNumber().toString(16).toUpperCase();
                // 根据SN找KEY
                String encPriKeyBase64 = getCertPriKeyWithSn(sn, pin);
                KeyFactory fact = KeyFactory.getInstance("ECDSA", new BouncyCastleProvider());
                PrivateKey encPrivateKey = fact.generatePrivate(new PKCS8EncodedKeySpec(Base64.decode(encPriKeyBase64)));

                byte[] parseEnvelopedMessage = EnvelopeUtil.parseEnvelopedMessage(ciphertext.getBytes(StandardCharsets.UTF_8), encPrivateKey, x509Certificate);
                oriTextHex = Hex.toHexString(parseEnvelopedMessage);
            } catch (Exception e) {
                throw new RuntimeException("解信封异常" + e.getMessage());
            }
            return Hex.decode(oriTextHex);
        }
        throw new RuntimeException("非sm2信封结构");
    }

    /**
     * 解析证书
     */
    public Map<String, Object> parseCertificateBase64(String certificateBase64) {
        return parseCert(certificateBase64);
    }

    /**
     * 根据证书SN查询证书
     */
    public Map<String, Object> getCertificateWithSn(String sn) {
        checkCertsDir();
        File cersDir = new File(ROOT_PATH + CERTS_PATH);
        for (File certDir : cersDir.listFiles()) {
            if (certDir.isDirectory() && (certDir.getName().split(",")[1].equalsIgnoreCase(sn) || certDir.getName().split(",")[2].equalsIgnoreCase(sn))) {
                for (File certFile : certDir.listFiles()) {
                    if (certFile.getName().split("\\.")[0].equalsIgnoreCase(sn)) {
                        byte[] certBytes;
                        try {
                            certBytes = read(certFile.getParentFile(), certFile.getName());
                        } catch (Exception e) {
                            throw new RuntimeException("读取SN证书异常" + e);
                        }
                        return parseCert(Base64.toBase64String(certBytes));
                    }
                }
            }
        }
        return new HashMap<>(0);
    }


    //*****************************************未实现**********************************************//
    public String generateTimestampReq(byte[] src, String hashType) {
        // 没有
        return null;
    }

    public boolean addCertificate(String certType, String pin, String certSys) {
        // thk's todo 2024/8/13 11:10 没懂什么意思??
        return false;
    }

    public boolean generateTimestampResp(String req) {
        // 没有
        return false;
    }

    public String updateTimestampInPKCS7Signature(byte[] pkcs7Signature, byte[] timestampResp) {
        // 没有
        return null;
    }

    public String encodePKCS7SignatureWithTimestamp(byte[] pkcs1Signature, byte[] certificate, byte[] timestampResp, byte[] src, boolean withSrc, String hash) {
        // 没有
        return null;
    }

    public void cancelAddCertificate() {
        // 没有
    }

    public byte[] sm2dh(String certificate, String pin, byte[] ra, byte[] Pb, byte[] Rb, int keylen) {
        // 没有
        return new byte[0];
    }

    public void importCertificate(String sign, String encryption, String key) {
        // 没有
    }

    public void deleteCertificate(String certificate) {
        // 没有
    }

    public void clearCertificates() {
        // 没有
    }

    //***************************************内部方法********************************************//

    /**
     * 根据证书SN找这张证书的私钥
     */
    private String getCertPriKeyWithSn(String sn, String pinCode) {
        checkCertsDir();
        // 先去拿PRI下的key，如果所有双证的加密证书SN都不匹配，再最后返回这个key
        String priAndPub;
        try {
            priAndPub = checkPinCode(pinCode, "");
        } catch (IOException e) {
            throw new RuntimeException("获取单证的KEY异常：" + e.getMessage());
        }
        String signPri = priAndPub.split(",")[1];

        File cersDir = new File(ROOT_PATH + CERTS_PATH);
        for (File certDir : cersDir.listFiles()) {
            // 双证
            if ("DOUBLE".equalsIgnoreCase(certDir.getName().split(",")[0])) {
                // 加密的SN
                if (certDir.isDirectory() && certDir.getName().split(",")[2].equalsIgnoreCase(sn)) {
                    for (File certFile : certDir.listFiles()) {
                        if (sn.equalsIgnoreCase(certFile.getName().split("\\.")[0]) && "key".equalsIgnoreCase(certFile.getName().split("\\.")[1])) {
                            try {
                                // 解加密私钥的信封（不是普通的信封）
                                String encPriEnvelop = Base64.toBase64String(Files.readAllBytes(certFile.toPath()));
                                String encD = EnvelopeUtil2.openTheEnvelope(encPriEnvelop, Hex.toHexString(Base64.decode(signPri)));
                                ECNamedCurveParameterSpec sm2Spec = ECNamedCurveTable.getParameterSpec("sm2p256v1");
                                ECParameterSpec ecSpec = new ECParameterSpec(
                                        sm2Spec.getCurve(),
                                        sm2Spec.getG(),
                                        sm2Spec.getN(),
                                        sm2Spec.getH());
                                KeyFactory fact = KeyFactory.getInstance("ECDSA", new BouncyCastleProvider());
                                BigInteger d1 = new BigInteger(1, Hex.decode(encD));
                                PrivateKey encPrivateKey = fact.generatePrivate(new ECPrivateKeySpec(d1, ecSpec));
                                return Base64.toBase64String(encPrivateKey.getEncoded());
                            } catch (Exception e) {
                                throw new RuntimeException("获取加密证书KEY读取异常：" + e.getMessage());
                            }
                        }
                    }
                    throw new RuntimeException("加密SN相等，却找不到KEY");
                }
            }
        }
        return signPri;
    }

    private void checkCertsDir() {
        File cersDir = new File(ROOT_PATH + CERTS_PATH);
        if (!cersDir.exists()) {
            if (!cersDir.mkdir()) {
                throw new RuntimeException("创建证书列表目录失败");
            }
        }
    }

    private List<String> getAllCerts() {
        checkCertsDir();
        File cersDir = new File(ROOT_PATH + CERTS_PATH);
        if (!cersDir.exists()) {
            return new ArrayList<>(0);
        }
        List<String> certList = new ArrayList<>();
        for (File certDir : cersDir.listFiles()) {
            if (certDir.isDirectory()) {
                String singleOrDouble = certDir.getName().split(",")[0];
                String SN = certDir.getName().split(",")[1];
                for (File certFile : certDir.listFiles()) {
                    if (certFile.isFile() && (certFile.getName().split("\\.")[0].equalsIgnoreCase(SN) || (singleOrDouble.equals("DOUBLE") && certFile.getName().split("\\.")[1].equalsIgnoreCase("cer")))) {
                        byte[] certBytes;
                        try {
                            certBytes = read(certFile.getParentFile(), certFile.getName());
                        } catch (Exception e) {
                            throw new RuntimeException("获取证书文件异常" + e.getMessage());
                        }
                        certList.add(Base64.toBase64String(certBytes));
                    }
                }
            }
        }
        return certList;
    }

    private void checkRepeatCert(String sn) {
        File cersDir = new File(ROOT_PATH + CERTS_PATH);
        for (File file : cersDir.listFiles()) {
            if (file.isDirectory()) {
                if (file.getName().equalsIgnoreCase("SINGLE," + sn) || file.getName().equalsIgnoreCase("DOUBLE," + sn)) {
                    throw new RuntimeException("此证书SN重复导入");
                }
            }
        }
    }

    public boolean updatePinCode(String oldPin, String newPin) {
        if (oldPin.equalsIgnoreCase(newPin)) {
            throw new IllegalArgumentException("重复PIN修改");
        }
        String priAndPub;
        try {
            priAndPub = checkPinCode(oldPin, "");
        } catch (IOException e) {
            throw new RuntimeException("oldPin验证异常" + e.getMessage());
        }
        // 用pin码加密priAndPub
        // DESede
        byte[] aesKey = pinToKey(newPin);
        SecretKey secretKey = new SecretKeySpec(aesKey, "DESede");
        // 对称加密
        byte[] encrypt = DESencrypt(priAndPub.getBytes(StandardCharsets.UTF_8), secretKey);
        File pinPriFile = new File(ROOT_PATH + PRI_FILE_PATH);
        try {
            if (!pinPriFile.delete()) {
                throw new RuntimeException("删除OLDPRI文件异常");
            }
            write(pinPriFile.getParentFile(), pinPriFile.getName(), encrypt);
        } catch (Exception e) {
            throw new RuntimeException("写入私钥文件失败" + e.getMessage());
        }
        return true;
    }

    public String checkPinCode(String PIN, String certType) throws IOException {
        File pinPriFile = new File(ROOT_PATH + PRI_FILE_PATH);
        if (!pinPriFile.exists()) {
            System.out.println("不存在PIN码，开始初始化PIN私钥");
            if (!pinPriFile.getParentFile().exists()) {
                if (!pinPriFile.getParentFile().mkdirs()) {
                    System.out.println("创建目录异常");
                    throw new RuntimeException("创建目录异常");
                }
            }
            if (certType.isEmpty()) {
                throw new IllegalArgumentException("certType为空，不存在现有PIN码，无法操作");
            }
            // 生成私钥
            String alg = certType.substring(0, 3);
            String keyLength = certType.substring(3);
            KeyPair keyPair = KeyUtil.generateKeyPair(alg, Integer.parseInt(keyLength));
            PrivateKey aPrivate = keyPair.getPrivate();
            PublicKey aPublic = keyPair.getPublic();
            String priBase64 = Base64.toBase64String(aPrivate.getEncoded());
            String pubBase64 = Base64.toBase64String(aPublic.getEncoded());
            String priAndPub = certType + "," + priBase64 + "," + pubBase64;
            // 用pin码加密priAndPub
            // DESede
            byte[] aesKey = pinToKey(PIN);
            SecretKey secretKey = new SecretKeySpec(aesKey, "DESede");
            // 对称加密
            byte[] encrypt = DESencrypt(priAndPub.getBytes(StandardCharsets.UTF_8), secretKey);
            // 验证下
            // System.out.println("验证下>> " + new String(DESdecrypt(encrypt, secretKey), StandardCharsets.UTF_8));
            write(pinPriFile.getParentFile(), pinPriFile.getName(), encrypt);
            return priAndPub;
        } else {
            // System.out.println("存在PIN码，开始验证PIN正确性");
            byte[] encData = read(pinPriFile.getParentFile(), pinPriFile.getName());
            // 用pin码解密priAndPub
            // DESede
            byte[] aesKey = pinToKey(PIN);
            SecretKey secretKey = new SecretKeySpec(aesKey, "DESede");
            byte[] decrypt = new byte[0];
            try {
                decrypt = DESdecrypt(encData, secretKey);
            } catch (Exception e) {
                throw new IllegalArgumentException("输入PIN错误");
            }
            String priAndPub = new String(decrypt);
            String keyType = priAndPub.split(",")[0];
            if (!certType.isEmpty() && !keyType.equalsIgnoreCase(certType)) {
                throw new IllegalArgumentException("要操作的密钥类型跟现有密钥类型不一致");
            }
            // System.out.println("解密>> " + priAndPub);
            return priAndPub;
        }
    }

    private static byte[] md5(String pin) {
        MessageDigest md = null;
        try {
            md = MessageDigest.getInstance("MD5");
        } catch (NoSuchAlgorithmException e) {
            throw new RuntimeException("摘要异常" + e.getMessage());
        }
        byte[] hashInBytes = md.digest(pin.getBytes(StandardCharsets.UTF_8));
        return hashInBytes;
    }

    private static byte[] pinToKey(String pin) {
        // 摘要一下
        byte[] hashInBytes = md5(pin);
        // 将摘要作为密钥（这里位数不足，循环填充）
        // 填充24位的DESede
        byte[] aesKey = new byte[24];
        fillArray(aesKey, hashInBytes);
        return aesKey;
    }

    public static void fillArray(byte[] A, byte[] B) {
        int lengthB = B.length;
        int lengthA = A.length;

        // 逐个填充A
        for (int i = 0; i < lengthA; i++) {
            A[i] = B[i % lengthB];
        }
    }

    private static byte[] DESencrypt(byte[] text, Key key) {
        try {
            Cipher cipher = Cipher.getInstance("DESede/ECB/PKCS5Padding");
            cipher.init(Cipher.ENCRYPT_MODE, key);
            return cipher.doFinal(text);
        } catch (NoSuchAlgorithmException | NoSuchPaddingException | InvalidKeyException | IllegalBlockSizeException |
                 BadPaddingException e) {
            throw new RuntimeException("加密异常" + e.getMessage());
        }
    }

    private static byte[] DESdecrypt(byte[] encryptedText, Key key) {
        try {
            Cipher cipher = Cipher.getInstance("DESede/ECB/PKCS5Padding");
            cipher.init(Cipher.DECRYPT_MODE, key);
            return cipher.doFinal(encryptedText);
        } catch (NoSuchAlgorithmException | NoSuchPaddingException | InvalidKeyException | IllegalBlockSizeException |
                 BadPaddingException e) {
            throw new RuntimeException("解密异常" + e.getMessage());
        }
    }

    private static byte[] genP10(String priAndPub) throws NoSuchAlgorithmException, InvalidKeySpecException, IOException {
        final String[] priAndPubArray = priAndPub.split(",");
        final String certType = priAndPubArray[0];
        final String priBase64 = priAndPubArray[1];
        final String pubBase64 = priAndPubArray[2];
        String alg;
        if (certType.toUpperCase().contains("RSA")) {
            alg = "SHA1withRSA";
        } else {
            alg = "SM3withSm2";
        }
        final PublicKey aPublic = certTest.KeyUtil.parsePubKey(pubBase64);
        final PrivateKey aPrivate = certTest.KeyUtil.parsePriKey(priBase64);
        String subjectParam = "CN=MCSCA";
        return Base64.decode(CertRequestUtil.generateP10(alg, subjectParam, new KeyPair(aPublic, aPrivate)));
    }

    private static Map<String, Object> parseCert(String certificateBase64) {
        Map<String, Object> parseCertMap = new HashMap<>();
        byte[] certBytes = Base64.decode(certificateBase64);
        ByteArrayInputStream inputStream = new ByteArrayInputStream(certBytes);
        java.security.cert.X509Certificate x509Certificate = CertUtil.getX509Certificate(inputStream);
        parseCertMap.put("notBefore", x509Certificate.getNotBefore());
        parseCertMap.put("notAfter", x509Certificate.getNotAfter());
        try {
            parseCertMap.put("certEncode", Base64.toBase64String(x509Certificate.getEncoded()));
        } catch (CertificateEncodingException e) {
            throw new RuntimeException("getEncoded异常" + e.getMessage());
        }
        parseCertMap.put("serialNumber", Hex.toHexString(x509Certificate.getSerialNumber().toByteArray()));
        parseCertMap.put("issuerDN", x509Certificate.getIssuerDN().toString());
        String subjectDN = x509Certificate.getSubjectDN().toString();
        parseCertMap.put("subjectDN", subjectDN);
        parseCertMap.put("publicKey", Base64.toBase64String(x509Certificate.getPublicKey().getEncoded()));
        String sigAlgName = x509Certificate.getSigAlgName();
        if (sigAlgName.toLowerCase().contains("sm2")) {
            parseCertMap.put("certType", "SM2");
        } else {
            int keyLength = KeyUtil2.getKeyLengthFromPublicKey(x509Certificate.getPublicKey());
            parseCertMap.put("certType", "RSA" + keyLength);
        }
        parseCertMap.put("subjectCN", getCNFromDN(subjectDN));

        parseCertMap.put("certBase64", certificateBase64);
        return parseCertMap;
    }

    /**
     * 从证书DN中获取到CN项
     *
     * @param DN DN字符串
     * @return CN项
     */
    public static String getCNFromDN(String DN) {
        X500Name x500Name = new X500Name(DN);
        return getCNFromX500Name(x500Name);
    }

    /**
     * 从证书DN中获取到CN项
     *
     * @param subject X500Name对象
     * @return CN项
     */
    public static String getCNFromX500Name(X500Name subject) {
        RDN[] rdNs = subject.getRDNs(BCStyle.CN);
        if (rdNs.length > 0) {
            return rdNs[0].getFirst().getValue().toString();
        }
        return subject.toString();
    }

    public static void write(File dir, String fileName, byte[] content) {
        if (dir != null) {
            File file = new File(dir, fileName);
            try (FileOutputStream fos = new FileOutputStream(file)) {
                fos.write(content);
                fos.flush();
            } catch (IOException e) {
                e.printStackTrace();
                throw new RuntimeException("写入文件异常");
            }
        }
    }

    public static byte[] read(File dir, String fileName) {
        if (dir == null) {
            return null;
        }
        File file = new File(dir, fileName);
        try (FileInputStream fis = new FileInputStream(file);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            byte[] buffer = new byte[1024];
            int length;
            while ((length = fis.read(buffer)) != -1) {
                baos.write(buffer, 0, length);
            }
            return baos.toByteArray();
        } catch (IOException e) {
            e.printStackTrace();
            return null;
        }
    }

}
