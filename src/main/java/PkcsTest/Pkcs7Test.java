package PkcsTest;

import cn.com.mcsca.bouncycastle.util.encoders.Base64;
import cn.com.mcsca.itextpdf.text.pdf.security.BouncyCastleDigest;
import cn.com.mcsca.itextpdf.text.pdf.security.DigestAlgorithms;
import cn.hutool.core.io.FileUtil;
import lombok.SneakyThrows;
import org.bouncycastle.asn1.ASN1Encodable;
import org.bouncycastle.asn1.ASN1InputStream;
import org.bouncycastle.asn1.ASN1OctetString;
import org.bouncycastle.asn1.ASN1Primitive;
import org.bouncycastle.asn1.ASN1Sequence;
import org.bouncycastle.asn1.ASN1Set;
import org.bouncycastle.asn1.ASN1TaggedObject;
import org.bouncycastle.jce.provider.BouncyCastleProvider;
import org.bouncycastle.util.encoders.Hex;
import org.junit.jupiter.api.Test;

import java.io.ByteArrayInputStream;
import java.security.MessageDigest;
import java.security.Security;
import java.security.Signature;
import java.security.cert.Certificate;
import java.security.cert.CertificateFactory;
import java.security.cert.X509Certificate;

/**
 * @author TangHaoKai
 * @version V1.0 2024/1/5 18:29
 **/
public class Pkcs7Test {

    @SneakyThrows
    public static void main(String[] args) {
        Security.addProvider(new BouncyCastleProvider());
        // bjca的signdata
        // String hex = "308212C2060A2A811CCF550601040202A08212B2308212AE020101310F300D06092A811CCF55018311020500300C060A2A811CCF550601040201A0820C3930820C3530820BDBA003020102020910528100000402937C300A06082A811CCF55018375308184310B300906035504061302434E310C300A06035504080C03202222310C300A06035504070C03202222310D300B060355040A0C04424A434131253023060355040B0C1C424A434120416E7977726974652054727573742053657276696365733123302106035504030C1A54727573742D5369676E20534D322043412D3220303030353030301E170D3232303531303037353033345A170D3232303531313037353033345A303C310B300906035504060C02434E312D302B06035504030C24E5B9B3E5AE89E7A791E68A80EFBC88E6B7B1E59CB3EFBC89E69C89E99990E585ACE58FB83059301306072A8648CE3D020106082A811CCF5501822D0342000491D28B11CCE7BD26834CE61A4821C0B0198F4E5CBB0E980463DB3BCFBB66CF5972B2546E821E8E8EB755B9D711E8285A2DE5F1857D2D4FE06959C72E8EF4A3FAA3820A7B30820A77301F0603551D23041830168014737A9DA707D21484D2BD6D7E00A894B385BAF423301D0603551D0E041604147E502EC72DD52F68A2CF1F937AB9C6B4CF1AB3EB300B0603551D0F0404030206C0308209E4060A2A811C86EF3202010901048209D40C8209D065794A575A584A7A61573975496A6F694D79347949697769535552556558426C496A6F694D534973496B6C45546E5674596D5679496A6F695A585631614768424B324E714C3363724E6B6F7859336C476232784A55315A525657387661444D795A47685052484930596A4E3061484678637A30694C434A535958644959584E6F496A6F69655564564D303078636A464E536D787861545A7256476C7A4E56526C656C493562546B304F55315852484A5A563149725356643151314247627A30694C434A43615739475A57463064584A6C496A7037496C4E6A636D6C776443493665794A4762334A74595851694F694A36615841694C434A586157523061434936496A45344D434973496B4E7662473979496A6F694D434973496B4E7664573530496A6F694D54453549697769556D566D56326C6B644767694F6A49774D437769556D566D534756705A326830496A6F784D444173496B5268644745694F694A6C536E683062465977567A564462306C6F54697436624852334E556C3152464176616D4D7953445A4B536D51344C335273656A5258526C6C525132396D613352305A446335616A6B76624556315257747A617A5654543074326433497A61325630637A6C77636E6F32646D4E775A6A64514E323078644731315432563555336878595339556555705157474533576D4A315132565055466C3552334D33556A4A7953444E6E6354597A616B35456379744B4E566B79596974754E57356861544A4C4D6B6C6B576C6F355A4577314D544E515A4556685A4731304D30786C6245703254326834536C4D33655841336553397961564E4C595373344E30316C4D69383161334A46626D6C49537A524459586852555739365A3246754F5864714B336877567A52355346647459326B336348525A515646715A30705461305A3254565255557A4E3162486436645652324B7A45324E3268334F466F3265465979626A4E355258707864307733547A4A364E6A4A6D59566C545A475A544E693946626B6F794B335A565A5656725347744E4D6C6C6A5955355951334177576D4647526E45324C323943636B707153584E6859574E4C616E4176546C707561474E6D5457785A5A326C53536B6C5155336C774D6A466D616D6C6E63454643556D31446557633262556C52516C426A6255564A65454E6C54575649563146495558553557584E71536E457A5A6A524C5A31645855324A495A6A52445A484D7A566A68566154567253444533596B31485A316B784E4764485333564F6332355559565A614E48553363305A314E5535435645353563307870527A51355A305A4F57473872646B744363564A545A564644576B745A656C4A57526A686F576A5A515456524F62473972534539695256464D556B6C35526D52314E48687451584E4364475A4B5230457765476479626C4E356332565551306B76535735495A7A6C475556525157555A4D556D6C30554570775957637A526E566951544E434E6C4E79576A644653464A32623039304D30685459305234574464494D6E4D774E6E4A4D63546B31646B4E70626B705657544673546D704C64556C6B52475A775455685356315A45646C5A4965545250525538796430646D4E334A56543235755A55686B63485259526E41315748524F5446565A616E56326269744851574A53596B3135626E524E576A4644516B31515A5646475A43394E5A446445536D5A496358565953473158546B5A344D6C566B52574679616E5A584D445977646E705262474A6D556E517A565564595955357A516A6C4253314645536A6443637A5270524756425A45316954584E3461485A526245315653556C5164444235625574524D4573335A46704253554676546A68455445565A5158466B5130567563557852626E7073597A5131543074714E566C7856465A514F55564457454E6163587046627A457856305236636D564C4F477473525545314E5746345658524764454E4463316C4564484E434D30644D6448564E5A6D703352485A596247685A6345315562575534526C553361336C3462323835537A426C546E6C31516D64324D306458616C56546445644B644464575355564665437377576B5578536E466C566C6C53516E6F3064336C4E536D39545745395959315A7562793935536E4E4A5A44644C516E704C513056354D33684A63305A6F5A6D6772516E425664316F7A4D307430524339615448643464325A535130396A646C564C623056355555557A6554645A6346684361574A7A596A685964326471546C70464F556C33513164754F4846524D6C4A72656C5534546C4245544739496156637853474E505A6D67344D555A335A576C3652585A5A55466434636C4E4356476B7651307071543163786147786D636C42324E48466F5258706E4D6D64715954513461545643543268304F437449553252775347466F535852514E45747A4B324930526C6C6B5A307854543370705346686862477855536C7030546A684A6253394D4E473834553259344D5463344B326431646A4531655567694C434A455A585A70593255694F6E73695247563261574E6C546D46745A534936496B464F52464A5053555266554546455830356C64484E6A5958426C49697769553246746347786C556D46305A534936496A45774D6A51694C434A51636D567A6330316865434936496A45774D6A51694C434A5861575230614349364F546B354F546B73496B686C6157646F644349364F546B354F546B73496B527961585A6C636C5A6C63694936496E59784C6A416966583073496C426F6233527651584A7959586B694F6C74644C434A54623356755A454679636D4635496A7062585377695647563464454679636D4635496A706265794A44623235305A573530496A6F696531776964584E6C636C77694F6C77693570326F3562694758434A39496E31644C434A506447686C636B4679636D4635496A706258583073496B4E736157567564453954496A7037496B3568625755694F694A585A576C59615735666156426F6232356C496977695257527064476C7662694936496B3176656D6C73624745694C434A545A584A3261574E6C5547466A61794936496B3576626D55694C434A575A584A7A61573975496A6F694E5334774943687055476876626D553749454E515653427055476876626D556754314D674D5452664E6942736157746C4945316859794250557942594B534242634842735A56646C596B7470644338324D4455754D5334784E53416F533068555455777349477870613255675232566A6132387049453176596D6C735A5338784E5555784E44676749485A6C636E4E70623235446232526C505459324D54417749476C51614739755A565235634755396156426F6232356C4D544D734D69426A6248567A644756794C575675646A30675545465164576831615546776344314F5A5864516457683161534973496B395451584A6A61434936496A4D794C7A5930496E313930400603551D2004393037303506092A811C86EF320202023028302606082B06010505070201161A687474703A2F2F7777772E626A63612E6F72672E636E2F637073300A06082A811CCF550183750348003045022100C7B21733049C05DF60C61A6722973AC7614930597E8B92BA0FB6C73367944F7C022061C065FA99756D680F6B32E2E10733657E942811D088E0447CE63C2CF2335BBB3182064B30820647020101308192308184310B300906035504061302434E310C300A06035504080C03202222310C300A06035504070C03202222310D300B060355040A0C04424A434131253023060355040B0C1C424A434120416E7977726974652054727573742053657276696365733123302106035504030C1A54727573742D5369676E20534D322043412D3220303030353030020910528100000402937C300D06092A811CCF55018311020500A06A301906092A864886F70D010903310C060A2A811CCF550601040201301C06092A864886F70D010905310F170D3232303531303037353033345A302F06092A864886F70D010904312204209A036CA8F39A8E1CE8B404BC1EF194443E2C198D2A9630D90E1AF789094F61D3300D06092A811CCF5501822D01050004483046022100F6FA67D8DD56C98FAF143FDDBBA60FCC8D6D01653F29D9F29ACDB1DA05EE84F1022100D11DD81DAC822614E1E117937A95935B94ED0C61E0595540D1748AF3D7427FD9A18204D7308204D3060B2A864886F70D010910020E318204C2308204BE060A2A811CCF550601040202A08204AE308204AA020101310F300D06092A811CCF550183110105003066060B2A864886F70D0109100104A0570455305302010106082B06010505070308302D06092A811CCF55018311010420EA89FB33C40D1AAB269EA7BC9AF8CCABAF10A05016A074DF7FD0D106EFA45E64020405F5E101180F32303232303531303037353033345AA08202F7308202F33082029AA003020102020A1A1000000000002ADC0B300A06082A811CCF550183753044310B300906035504061302434E310D300B060355040A0C04424A4341310D300B060355040B0C04424A43413117301506035504030C0E4265696A696E6720534D32204341301E170D3135313130353136303030305A170D3235313130363135353935395A3081A3311E301C06035504030C15E697B6E997B4E688B3E69C8DE58AA1E8AF81E4B9A631543052060355040B0C4BE5B9B3E5AE89E7A791E68A80E7A7BBE58AA8E794B5E5AD90E4BF9DE58D95E7B3BBE7BB9FE5AE9AE588B6E58C96E6898BE58699E695B0E5AD97E7ADBEE5908DE5BA94E794A8E9A1B9E79BAE310D300B060355040A0C04424A4341310F300D060355040A0C06424A43415453310B300906035504060C02434E3059301306072A8648CE3D020106082A811CCF5501822D034200046D88986370960179D142C6D27D6F4CD59F695BC7D3F8342D04A6E4E80A1D490851EC9135586A4FD129D5387A271C97B79EEF00A2AD433F9B21C4F786BF4F7DE5A38201123082010E301F0603551D230418301680141FE6CFD48FC5222A974A298A15E716C99234C4B630819D0603551D1F0481953081923060A05EA05CA45A3058310B300906035504061302434E310D300B060355040A0C04424A4341310D300B060355040B0C04424A43413117301506035504030C0E4265696A696E6720534D3220434131123010060355040313096361323163726C3135302EA02CA02A8628687474703A2F2F63726C2E626A63612E6F72672E636E2F63726C2F6361323163726C31352E63726C301106096086480186F84201010404030200FF300B0603551D0F0404030203F830160603551D250101FF040C300A06082B060105050703083013060A2A811C86EF320201011E04050C03363534300A06082A811CCF5501837503470030440220678A0042D66802375ECAF9FB4F05580FC5926D95E859873C82DF0151CB6F9A1102203BCB6DDA84A969ADF976A1F164BEC0B37380C467507AD10F7AEF450E97A409D23182012F3082012B02010130523044310B300906035504061302434E310D300B060355040A0C04424A4341310D300B060355040B0C04424A43413117301506035504030C0E4265696A696E6720534D32204341020A1A1000000000002ADC0B300C06082A811CCF550183110500A06B301A06092A864886F70D010903310D060B2A864886F70D0109100104301C06092A864886F70D010905310F170D3232303531303037353033345A302F06092A864886F70D0109043122042003FDE0D0E3CBD69005F477DD335A1EEA94B26F5ED8DB1A69C0195679D51F8007300D06092A811CCF5501822D01050004483046022100AEAE3D38535E9188F2DDC3BA81784AAC09953035EB34E1CE5EEF8739F7723BF50221008C4C6433354D18DD523883859C8897BB2A08EB48D07A5310FE7EF07F27390578";
        // long[] longs = new long[]{0, 122174, 151076, 4745};
        // byte[] pdfBytes = FileUtil.readBytes("C:\\Users\\ggk911\\Desktop\\个人信息授权书(2).pdf");

        // 通过annot自建的
        String hex = "308209c606092a864886f70d010702a08209b7308209b3020101310e300c06082a811ccf550183110500300b06092a864886f70d010701a082029c308202983082023fa003020102020103300a06082a811ccf550183753058310b300906035504061302434e310e300c060355040a0c054368696e6131153013060355040b0c0c496e7465726d6564696174653122302006092a864886f70d01090116133133393833303533343535403136332e636f6d301e170d3234303130323039303935315a170d3235303130313039303935315a3066310b300906035504061302434e310e300c060355040a0c054368696e613112301006035504070c0943686f6e6771696e67310f300d06035504030c0647474b3931313122302006092a864886f70d01090116133133393833303533343535403136332e636f6d3059301306072a8648ce3d020106082a811ccf5501822d034200048d9c45d3af5c6fc9e8821728ef24c0a2b55474509eb75337d4e1fb68180d1e8ecdcf9ff08b6ad088ccb7f08f38a68aa19fee31bc5317ce11d0d8f101252e4a9ea381eb3081e8301d0603551d0e041604149344fed3eb60002b17418d0e4c0e922f43e79a0c301f0603551d230418301680148a9d5fb6b9adff896bc777ca4dc7cd304509896230090603551d1f04023000305f06082b060105050701010101ff0450304e302806082b06010505073001821c687474703a2f2f3132372e302e302e312f636169737375652e68746d302206082b060105050730028216687474703a2f2f3132372e302e302e313a3230343433300e0603551d0f0101ff0404030206c030120603551d130101ff040830060101ff02010330160603551d250101ff040c300a06082b06010505070308300a06082a811ccf5501837503470030440220623263fcd18d876e578e94e8066124a98c036d0bcadbf15c50ebf163bb6b6227022002375437be349908301fa6d36280f0f68ca0646f1155ca67ad761458854db7ae318206ef308206eb020101305d3058310b300906035504061302434e310e300c060355040a0c054368696e6131153013060355040b0c0c496e7465726d6564696174653122302006092a864886f70d01090116133133393833303533343535403136332e636f6d020103300c06082a811ccf550183110500a069301806092a864886f70d010903310b06092a864886f70d010701301c06092a864886f70d010905310f170d3234303131383036333232375a302f06092a864886f70d0109043122042045e94c51928ec46f3cbac22a954ceb1a9a60497aa8cae9cb93fc8ca08f5744a1300c06082a811ccf5501822d050004483046022100dff3d8571e40bb1863595cd3cb4351738da897e65cc1fe85d104f762d0569a46022100cabeee83bbe913b29443cd2886069d58ecab3b57dd844ee0264fd37f2b4a06d4a18205b4308205b0060b2a864886f70d010910020e3182059f3082059b06092a864886f70d010702a082058c30820588020103310e300c06082a811ccf5501831105003078060b2a864886f70d0109100104a0690467306502010106082b060105050703083031300d0609608648016503040201050004204beba39d00e522dcc7612beb71706728cf6ed4efb6105e39d025363f835ac04f020a685bc047064921c5eec3180f32303234303131383036333232385a0206018d1b456143a082033b30820337308202dda003020102020a685bc047064921c5eec3300a06082a811ccf550183753061310b300906035504061302434e31363034060355040a0c2d4469676974616c20436572746966696361746520417574686f726974792043656e74657220436f2e2c204c7464311a301806035504030c11476c6f62616c2054534120534d32204341301e170d3233313232353033323431355a170d3238313232333033323431355a3063310b300906035504061302434e31363034060355040a0c2d4469676974616c20436572746966696361746520417574686f726974792043656e74657220436f2e2c204c7464311c301a06035504030c13476c6f62616c2054534120534d32205369676e3059301306072a8648ce3d020106082a811ccf5501822d034200041f65a3c6aaf46a6b371a82467a5fe8cb1c2045ed25f39072697aa9eabf15a19dca61ed6ab2aea53a4c329687eb7c9b4e4c0d16344b963c2f346b9a5610dc66b6a382017930820175300e0603551d0f0101ff040403020186300c0603551d130101ff04023000301f0603551d23041830168014347ffd7095fc658368c72a73b709eb6b2c3d0fad301d0603551d0e04160414b61b6f1bd7a4c59693d655396858c8c1ed458f0930160603551d250101ff040c300a06082b06010505070308303f0603551d1f043830363034a032a030862e687474703a2f2f312e31322e36372e3132363a383038312f63726c2f476c6f62616c545341534d3243412e63726c307e06082b0601050507010104723070303206082b060105050730018626687474703a2f2f312e31322e36372e3132363a383038322f6f6373702f6f6373705175657279303a06082b06010505073002862e687474703a2f2f312e31322e36372e3132363a383038312f6372742f476c6f62616c545341534d3243412e637274303c0603551d2004353033303106096086480186fd6c01053024302206082b060105050702011616687474703a2f2f312e31322e36372e3132362f637073300a06082a811ccf55018375034800304502207fd007b8f3c92cf75b00fcf7ce45b0fa22d5fe34e1fc6fbb1a528f4470a4b6d502210082443b2d3f073a30c58bb9961d709ea43ba9d07149afb93198e0946823f6d004318201b8308201b4020101306f3061310b300906035504061302434e31363034060355040a0c2d4469676974616c20436572746966696361746520417574686f726974792043656e74657220436f2e2c204c7464311a301806035504030c11476c6f62616c2054534120534d32204341020a685bc047064921c5eec3300c06082a811ccf550183110500a081db301a06092a864886f70d010903310d060b2a864886f70d0109100104301c06092a864886f70d010905310f170d3234303131383036333232385a302906092a864886f70d010934311c301a300c06082a811ccf550183110500a10a06082a811ccf55018375302f06092a864886f70d010904312204209cb42b07f77ddc9f8b299fb361b7ead666a1ab68971904fd798b0fc4fa90d2d83043060b2a864886f70d010910022f313430323030302e300a06082a811ccf55018311042052ff89a05242281be01dd06a2cefcb193c2a512281479d3c320452992bf8037f300a06082a811ccf5501837504463044022033850345d64c31bcdfc056f362dce608277babe6ab48115c30b0e3bf4aff0c3802203c4e4d717f23e4bd58e1c62dce4d9c383bf4e8fd9a525fe40673b41d9790bd78";
        long[] longs = new long[]{0, 7982, 18175, 124243};
        byte[] pdfBytes = FileUtil.readBytes("C:\\Users\\ggk911\\Desktop\\test01-1.pdf");

        ASN1InputStream asn1InputStream = new ASN1InputStream(Hex.decode(hex));
        //将hex转换为byte输出
        ASN1Primitive asn1Primitive;
        while ((asn1Primitive = asn1InputStream.readObject()) != null) {
            ASN1Sequence sequence = (ASN1Sequence) asn1Primitive;
            ASN1TaggedObject taggedObject = (ASN1TaggedObject) sequence.getObjectAt(1);
            ASN1Sequence sequence1 = (ASN1Sequence) taggedObject.getBaseObject();

            // 证书
            ASN1TaggedObject taggedObject1 = (ASN1TaggedObject) sequence1.getObjectAt(3);
            ASN1Sequence cert = (ASN1Sequence) taggedObject1.getBaseObject();
            System.out.println("证书" + Hex.toHexString(cert.getEncoded()));

            // 属性Attr
            ASN1Set signInfos = (ASN1Set) sequence1.getObjectAt(4);
            ASN1Sequence signInfo = (ASN1Sequence) signInfos.getObjectAt(0);
            ASN1TaggedObject signAttr = (ASN1TaggedObject) signInfo.getObjectAt(3);
            ASN1Set signAttr2 = ASN1Set.getInstance(signAttr, false);
            System.out.println("属性Attr" + Hex.toHexString(signAttr2.getEncoded()));

            // 原文range摘要
            ASN1Sequence signAttrSequence = (ASN1Sequence) signAttr.getBaseObject();
            ASN1Sequence signAttrSequenceSeq = (ASN1Sequence) signAttrSequence.getObjectAt(2);
            ASN1Set digestSet = (ASN1Set) signAttrSequenceSeq.getObjectAt(1);
            ASN1OctetString digest = (ASN1OctetString) digestSet.getObjectAt(0);
            System.out.println("原文range摘要" + Hex.toHexString(digest.getOctets()));

            // 签名值(属性Attr)
            ASN1OctetString signValueOcStr = (ASN1OctetString) signInfo.getObjectAt(5);
            ASN1Sequence signValue = (ASN1Sequence) new ASN1InputStream(signValueOcStr.getOctets()).readObject();
            System.out.println("签名值（属性Attr）" + Hex.toHexString(signValue.toASN1Primitive().getEncoded()));
            // SM3
            MessageDigest sm3 = new BouncyCastleDigest().getMessageDigest("SM3");
            sm3.update(signValue.toASN1Primitive().getEncoded());
            byte[] digest2 = sm3.digest();
            System.out.println("SM3(签名值)" + Hex.toHexString(digest2));

            // 时间戳
            ASN1TaggedObject timeStampTag = (ASN1TaggedObject) signInfo.getObjectAt(6);
            ASN1Sequence timeStampSequence = (ASN1Sequence) timeStampTag.getBaseObject();
            ASN1Set timeStampSet = (ASN1Set) timeStampSequence.getObjectAt(1);
            ASN1Sequence timeStampSequence2 = (ASN1Sequence) timeStampSet.getObjectAt(0);
            System.out.println("时间戳" + Hex.toHexString(timeStampSequence2.getEncoded()));

            ASN1TaggedObject timeStampTag2 = (ASN1TaggedObject) timeStampSequence2.getObjectAt(1);
            ASN1Sequence timeStampSequence3 = (ASN1Sequence) timeStampTag2.getBaseObject();


            // encapContentInfo eContent
            ASN1Sequence eContentSequence = (ASN1Sequence) timeStampSequence3.getObjectAt(2);
            ASN1TaggedObject eContentTag = (ASN1TaggedObject) eContentSequence.getObjectAt(1);
            ASN1OctetString eContent = (ASN1OctetString) eContentTag.getBaseObject();
            System.out.println("eContent:" + Hex.toHexString(eContent.getOctets()));

            // eContentSM3
            sm3.reset();
            sm3.update(eContent.getOctets());
            System.out.println("econtent摘要:" + Hex.toHexString(sm3.digest()));

            // 时间戳证书
            ASN1TaggedObject timeStampTag3 = (ASN1TaggedObject) timeStampSequence3.getObjectAt(3);
            ASN1Sequence timeCert = (ASN1Sequence) timeStampTag3.getBaseObject();
            System.out.println("时间戳证书" + Hex.toHexString(timeCert.getEncoded()));

            // 时间戳证书哈希
            sm3.reset();
            sm3.update(timeCert.getEncoded());
            System.out.println("时间戳证书哈希" + Hex.toHexString(sm3.digest()));

            ASN1Set timeStampAttrSet = (ASN1Set) timeStampSequence3.getObjectAt(4);
            ASN1Sequence timeStampAttrSequence = (ASN1Sequence) timeStampAttrSet.getObjectAt(0);

            // 时间戳属性
            ASN1TaggedObject timeStampAttrTag = (ASN1TaggedObject) timeStampAttrSequence.getObjectAt(3);
            ASN1Set timeStampAttr = ASN1Set.getInstance(timeStampAttrTag, false);
            System.out.println("时间戳属性" + Hex.toHexString(timeStampAttr.getEncoded()));

            // 时间戳原文摘要
            // 时间戳属性中的原文摘要位置不一样 2/3
            // ASN1Sequence timeStampAttrOriHashSeq = (ASN1Sequence) timeStampAttr.getObjectAt(2);
            ASN1Sequence timeStampAttrOriHashSeq = (ASN1Sequence) timeStampAttr.getObjectAt(3);
            ASN1Set timeStampAttrOriHashSet = (ASN1Set) timeStampAttrOriHashSeq.getObjectAt(1);
            ASN1OctetString timeStampAttrOriHash = (ASN1OctetString) timeStampAttrOriHashSet.getObjectAt(0);
            System.out.println("时间戳原文摘要" + Hex.toHexString(timeStampAttrOriHash.getOctets()));

            // 时间戳签名值(时间戳属性)
            ASN1OctetString timeStampSignValueOcStr = (ASN1OctetString) timeStampAttrSequence.getObjectAt(5);
            ASN1Sequence timeStampSignValue = (ASN1Sequence) new ASN1InputStream(timeStampSignValueOcStr.getOctets()).readObject();
            System.out.println("时间戳签名值" + Hex.toHexString(timeStampSignValue.getEncoded()));

            // 验属性签名值
            String publicCertSm2 = "MIICmDCCAj+gAwIBAgIBAzAKBggqgRzPVQGDdTBYMQswCQYDVQQGEwJDTjEOMAwGA1UECgwFQ2hpbmExFTATBgNVBAsMDEludGVybWVkaWF0ZTEiMCAGCSqGSIb3DQEJARYTMTM5ODMwNTM0NTVAMTYzLmNvbTAeFw0yNDAxMDIwOTA5NTFaFw0yNTAxMDEwOTA5NTFaMGYxCzAJBgNVBAYTAkNOMQ4wDAYDVQQKDAVDaGluYTESMBAGA1UEBwwJQ2hvbmdxaW5nMQ8wDQYDVQQDDAZHR0s5MTExIjAgBgkqhkiG9w0BCQEWEzEzOTgzMDUzNDU1QDE2My5jb20wWTATBgcqhkjOPQIBBggqgRzPVQGCLQNCAASNnEXTr1xvyeiCFyjvJMCitVR0UJ63UzfU4ftoGA0ejs3Pn/CLatCIzLfwjzimiqGf7jG8UxfOEdDY8QElLkqeo4HrMIHoMB0GA1UdDgQWBBSTRP7T62AAKxdBjQ5MDpIvQ+eaDDAfBgNVHSMEGDAWgBSKnV+2ua3/iWvHd8pNx80wRQmJYjAJBgNVHR8EAjAAMF8GCCsGAQUFBwEBAQH/BFAwTjAoBggrBgEFBQcwAYIcaHR0cDovLzEyNy4wLjAuMS9jYWlzc3VlLmh0bTAiBggrBgEFBQcwAoIWaHR0cDovLzEyNy4wLjAuMToyMDQ0MzAOBgNVHQ8BAf8EBAMCBsAwEgYDVR0TAQH/BAgwBgEB/wIBAzAWBgNVHSUBAf8EDDAKBggrBgEFBQcDCDAKBggqgRzPVQGDdQNHADBEAiBiMmP80Y2HbleOlOgGYSSpjANtC8rb8VxQ6/Fju2tiJwIgAjdUN740mQgwH6bTYoDw9oygZG8RVcpnrXYUWIVNt64=";
            ByteArrayInputStream bis = new ByteArrayInputStream(Base64.decode(publicCertSm2));
            CertificateFactory certificateFactory = CertificateFactory.getInstance("X.509", "BC");
            Certificate[] certificateChain = new Certificate[1];
            certificateChain[0] = certificateFactory.generateCertificate(bis);

            Signature signature = Signature.getInstance("SM3withSM2", "BC");
            // CertificateFactory fact = CertificateFactory.getInstance("X.509", "BC");
            // X509Certificate cert3 = (X509Certificate) fact.generateCertificate(new ByteArrayInputStream(cert.getEncoded()));
            // signature.initVerify(cert3.getPublicKey());
            signature.initVerify(certificateChain[0].getPublicKey());
            // signature.update(signAttr2.getEncoded());
            System.out.println("signAttr2"+Hex.toHexString(signAttr2.getEncoded()));
            signature.update(Hex.decode("3169301806092a864886f70d010903310b06092a864886f70d010701301c06092a864886f70d010905310f170d3234303131363033333933395a302f06092a864886f70d010904312204201dfb90c25fc18f8291f5bb86b520886bc6589e0b3f3d38f74a6d49651eea934d"));
            // boolean verify = signature.verify(signValue.toASN1Primitive().getEncoded());
            System.out.println("signValue"+Hex.toHexString(signValue.toASN1Primitive().getEncoded()));
            boolean verify = signature.verify(Hex.decode("3046022100bc7c9c860e3cd52b21f2d88919d41aff0f47fb0029e8dfd7e53999fc95b814e4022100f3c72ddd2b10d3bebbf69e61a6dabd756aece1b6b3baed98cceca7d317622fba"));
            System.out.println("验签名值" + verify);



            // pdf
            MessageDigest messageDigest = DigestAlgorithms.getMessageDigest("SM3", "BC");

            // 签名原文
            byte[] updateData = new byte[(int) (longs[1] + longs[3])];
            System.arraycopy(pdfBytes, 0, updateData, 0, (int) longs[1]);
            System.arraycopy(pdfBytes, (int) longs[2], updateData, (int) longs[1], (int) longs[3]);
            FileUtil.writeBytes(updateData, "C:\\Users\\ggk911\\Desktop\\个人信息授权书range");
            ByteArrayInputStream input = new ByteArrayInputStream(updateData);
            byte[] buf = new byte[8192];
            int rd;
            while ((rd = input.read(buf, 0, buf.length)) > 0) {
                messageDigest.update(buf, 0, rd);
            }

            // 原文HASH
            byte[] digest1 = messageDigest.digest();
            System.out.println("原文哈希" + Hex.toHexString(digest1));

            // 原文哈希 equals 原文range摘要
            System.out.println("原文哈希 equals 原文range摘要" + Hex.toHexString(digest1).equals(Hex.toHexString(digest.getOctets())));

            // 验时间戳签名值
            Signature signature2 = Signature.getInstance("SM3withSM2", "BC");
            CertificateFactory fact2 = CertificateFactory.getInstance("X.509", "BC");
            X509Certificate cert4 = (X509Certificate) fact2.generateCertificate(new ByteArrayInputStream(timeCert.getEncoded()));
            signature2.initVerify(cert4.getPublicKey());
            signature2.update(timeStampAttr.getEncoded());
            boolean verify2 = signature2.verify(timeStampSignValue.getEncoded());
            System.out.println("验时间戳签名值" + verify2);


        }
    }

    @Test
    @SneakyThrows
    public void cfca() {
        Security.addProvider(new BouncyCastleProvider());
        // cfca
        String hex = "3082046a060a2a811ccf550601040202a082045a30820456020101310e300c06082a811ccf550183110500300c060a2a811ccf550601040201a082035930820355308202f8a00302010202083300000437455398300c06082a811ccf550183750500305c310b300906035504061302434e3130302e060355040a0c274368696e612046696e616e6369616c2043657274696669636174696f6e20417574686f72697479311b301906035504030c12434643412041435320534d32204f43413333301e170d3232303631363130323735315a170d3237303631363130323735315a308184310b300906035504061302434e31173015060355040a0c0e4346434120414353204f434133313110300e060355040b0c07534353444e504f31153013060355040b0c0c496e646976696475616c2d313133303106035504030c2a30353140e99988e4bd99e6b3a240303531303530323139373830393330313731364036373030303030313059301306072a8648ce3d020106082a811ccf5501822d034200044451846de843f2d8aed14d0bb57fe21045357b1aaa3e9ac1af35b9682f1ca589b0636b60451c6c3e74181ea73231b317a60a04a885697f4af5cd6a37b858d093a382017730820173306c06082b060105050701010460305e302806082b06010505073001861c687474703a2f2f6f6373702e636663612e636f6d2e636e2f6f637370303206082b060105050730028626687474703a2f2f63726c2e636663612e636f6d2e636e2f6f636133332f6f636133332e636572301f0603551d2304183016801411d028219ef47259fe6408e99ddba469841271bc300c0603551d130101ff0402300030480603551d200441303f303d060860811c86ef2a01043031302f06082b060105050702011623687474703a2f2f7777772e636663612e636f6d2e636e2f75732f75732d31342e68746d303c0603551d1f043530333031a02fa02d862b687474703a2f2f63726c2e636663612e636f6d2e636e2f6f636133332f534d322f63726c3334302e63726c300e0603551d0f0101ff0404030206c0301d0603551d0e041604146663d0fe2f943dfcb869e2e91f1d1d973a0a019e301d0603551d250416301406082b0601050507030206082b06010505070304300c06082a811ccf5501837505000349003046022100d1afc714fe321021919912b2147ed1af7d32c468b4a7f2233c5048a3e6318b3d0221009e1df719825a4906b8b7ea626f37d593900ac3b9c7672aff0dbb68373d00b8913181d53081d20201013068305c310b300906035504061302434e3130302e060355040a0c274368696e612046696e616e6369616c2043657274696669636174696f6e20417574686f72697479311b301906035504030c12434643412041435320534d32204f4341333302083300000437455398300c06082a811ccf550183110500300d06092a811ccf5501822d010500044630440220456d7f2b3ebcaf230e6398c6e104b4c47fc921d63c97184c263a0c4474d964d20220726330728743ca5e9d2ced638406634194599254c9c765fe824edffc192bdb60";
        long[] longs = new long[]{0, 123104, 139490, 6817};
        byte[] pdfBytes = FileUtil.readBytes("C:\\Users\\ggk911\\Desktop\\cfca.pdf");

        ASN1InputStream asn1InputStream = new ASN1InputStream(Hex.decode(hex));
        //将hex转换为byte输出
        ASN1Primitive asn1Primitive;
        while ((asn1Primitive = asn1InputStream.readObject()) != null) {
            ASN1Sequence sequence = (ASN1Sequence) asn1Primitive;
            ASN1TaggedObject taggedObject = (ASN1TaggedObject) sequence.getObjectAt(1);
            ASN1Sequence sequence1 = (ASN1Sequence) taggedObject.getBaseObject();

            // 证书
            ASN1TaggedObject taggedObject1 = (ASN1TaggedObject) sequence1.getObjectAt(3);
            ASN1Sequence cert = (ASN1Sequence) taggedObject1.getBaseObject();
            System.out.println("证书" + Hex.toHexString(cert.getEncoded()));

            // 属性Attr
            ASN1Set signInfos = (ASN1Set) sequence1.getObjectAt(4);
            ASN1Sequence signInfo = (ASN1Sequence) signInfos.getObjectAt(0);
            // cfca的类型不一样
            ASN1Sequence signAttr = (ASN1Sequence) signInfo.getObjectAt(3);
            System.out.println("属性Attr" + Hex.toHexString(signAttr.getEncoded()));


            // cfca直接没有
            // 原文range摘要
            // ASN1Sequence signAttrSequence = (ASN1Sequence) signAttr.getBaseObject();
            // ASN1Sequence signAttrSequenceSeq = (ASN1Sequence) signAttrSequence.getObjectAt(2);
            // ASN1Set digestSet = (ASN1Set) signAttrSequenceSeq.getObjectAt(1);
            // ASN1OctetString digest = (ASN1OctetString) digestSet.getObjectAt(0);
            // System.out.println("原文range摘要" + Hex.toHexString(digest.getOctets()));

            // 签名值(属性Attr)
            ASN1OctetString signValueOcStr = (ASN1OctetString) signInfo.getObjectAt(4);
            ASN1Sequence signValue = (ASN1Sequence) new ASN1InputStream(signValueOcStr.getOctets()).readObject();
            System.out.println("签名值（属性Attr）" + Hex.toHexString(signValue.toASN1Primitive().getEncoded()));
            // SM3
            MessageDigest sm3 = new BouncyCastleDigest().getMessageDigest("SM3");
            sm3.update(signValue.toASN1Primitive().getEncoded());
            byte[] digest2 = sm3.digest();
            System.out.println("SM3(签名值)" + Hex.toHexString(digest2));

            // 时间戳
            // ASN1TaggedObject timeStampTag = (ASN1TaggedObject) signInfo.getObjectAt(6);
            // ASN1Sequence timeStampSequence = (ASN1Sequence) timeStampTag.getBaseObject();
            // ASN1Set timeStampSet = (ASN1Set) timeStampSequence.getObjectAt(1);
            // ASN1Sequence timeStampSequence2 = (ASN1Sequence) timeStampSet.getObjectAt(0);
            // System.out.println("时间戳" + Hex.toHexString(timeStampSequence2.getEncoded()));
            //
            // ASN1TaggedObject timeStampTag2 = (ASN1TaggedObject) timeStampSequence2.getObjectAt(1);
            // ASN1Sequence timeStampSequence3 = (ASN1Sequence) timeStampTag2.getBaseObject();
            //
            //
            // encapContentInfo eContent
            // ASN1Sequence eContentSequence = (ASN1Sequence) timeStampSequence3.getObjectAt(2);
            // ASN1TaggedObject eContentTag = (ASN1TaggedObject) eContentSequence.getObjectAt(1);
            // ASN1OctetString eContent = (ASN1OctetString) eContentTag.getBaseObject();
            // System.out.println("eContent:" + Hex.toHexString(eContent.getOctets()));
            //
            // // eContentSM3
            // sm3.reset();
            // sm3.update(eContent.getOctets());
            // System.out.println("econtent摘要:" + Hex.toHexString(sm3.digest()));
            //
            // // 时间戳证书
            // ASN1TaggedObject timeStampTag3 = (ASN1TaggedObject) timeStampSequence3.getObjectAt(3);
            // ASN1Sequence timeCert = (ASN1Sequence) timeStampTag3.getBaseObject();
            // System.out.println("时间戳证书" + Hex.toHexString(timeCert.getEncoded()));
            //
            // // 时间戳证书哈希
            // sm3.reset();
            // sm3.update(timeCert.getEncoded());
            // System.out.println("时间戳证书哈希" + Hex.toHexString(sm3.digest()));
            //
            // ASN1Set timeStampAttrSet = (ASN1Set) timeStampSequence3.getObjectAt(4);
            // ASN1Sequence timeStampAttrSequence = (ASN1Sequence) timeStampAttrSet.getObjectAt(0);
            //
            // // 时间戳属性
            // ASN1TaggedObject timeStampAttrTag = (ASN1TaggedObject) timeStampAttrSequence.getObjectAt(3);
            // ASN1Set timeStampAttr = ASN1Set.getInstance(timeStampAttrTag, false);
            // System.out.println("时间戳属性" + Hex.toHexString(timeStampAttr.getEncoded()));
            //
            // // 时间戳原文摘要
            // // 时间戳属性中的原文摘要位置不一样 2/3
            // // ASN1Sequence timeStampAttrOriHashSeq = (ASN1Sequence) timeStampAttr.getObjectAt(2);
            // ASN1Sequence timeStampAttrOriHashSeq = (ASN1Sequence) timeStampAttr.getObjectAt(3);
            // ASN1Set timeStampAttrOriHashSet = (ASN1Set) timeStampAttrOriHashSeq.getObjectAt(1);
            // ASN1OctetString timeStampAttrOriHash = (ASN1OctetString) timeStampAttrOriHashSet.getObjectAt(0);
            // System.out.println("时间戳原文摘要" + Hex.toHexString(timeStampAttrOriHash.getOctets()));
            //
            // // 时间戳签名值(时间戳属性)
            // ASN1OctetString timeStampSignValueOcStr = (ASN1OctetString) timeStampAttrSequence.getObjectAt(5);
            // ASN1Sequence timeStampSignValue = (ASN1Sequence) new ASN1InputStream(timeStampSignValueOcStr.getOctets()).readObject();
            // System.out.println("时间戳签名值" + Hex.toHexString(timeStampSignValue.getEncoded()));

            // 验属性签名值
            String publicCertSm2 = "MIICmDCCAj+gAwIBAgIBAzAKBggqgRzPVQGDdTBYMQswCQYDVQQGEwJDTjEOMAwGA1UECgwFQ2hpbmExFTATBgNVBAsMDEludGVybWVkaWF0ZTEiMCAGCSqGSIb3DQEJARYTMTM5ODMwNTM0NTVAMTYzLmNvbTAeFw0yNDAxMDIwOTA5NTFaFw0yNTAxMDEwOTA5NTFaMGYxCzAJBgNVBAYTAkNOMQ4wDAYDVQQKDAVDaGluYTESMBAGA1UEBwwJQ2hvbmdxaW5nMQ8wDQYDVQQDDAZHR0s5MTExIjAgBgkqhkiG9w0BCQEWEzEzOTgzMDUzNDU1QDE2My5jb20wWTATBgcqhkjOPQIBBggqgRzPVQGCLQNCAASNnEXTr1xvyeiCFyjvJMCitVR0UJ63UzfU4ftoGA0ejs3Pn/CLatCIzLfwjzimiqGf7jG8UxfOEdDY8QElLkqeo4HrMIHoMB0GA1UdDgQWBBSTRP7T62AAKxdBjQ5MDpIvQ+eaDDAfBgNVHSMEGDAWgBSKnV+2ua3/iWvHd8pNx80wRQmJYjAJBgNVHR8EAjAAMF8GCCsGAQUFBwEBAQH/BFAwTjAoBggrBgEFBQcwAYIcaHR0cDovLzEyNy4wLjAuMS9jYWlzc3VlLmh0bTAiBggrBgEFBQcwAoIWaHR0cDovLzEyNy4wLjAuMToyMDQ0MzAOBgNVHQ8BAf8EBAMCBsAwEgYDVR0TAQH/BAgwBgEB/wIBAzAWBgNVHSUBAf8EDDAKBggrBgEFBQcDCDAKBggqgRzPVQGDdQNHADBEAiBiMmP80Y2HbleOlOgGYSSpjANtC8rb8VxQ6/Fju2tiJwIgAjdUN740mQgwH6bTYoDw9oygZG8RVcpnrXYUWIVNt64=";
            ByteArrayInputStream bis = new ByteArrayInputStream(Base64.decode(publicCertSm2));
            CertificateFactory certificateFactory = CertificateFactory.getInstance("X.509", "BC");
            Certificate[] certificateChain = new Certificate[1];
            certificateChain[0] = certificateFactory.generateCertificate(bis);

            Signature signature = Signature.getInstance("SM3withSM2", "BC");
            // CertificateFactory fact = CertificateFactory.getInstance("X.509", "BC");
            // X509Certificate cert3 = (X509Certificate) fact.generateCertificate(new ByteArrayInputStream(cert.getEncoded()));
            // signature.initVerify(cert3.getPublicKey());
            signature.initVerify(certificateChain[0].getPublicKey());
            // signature.update(signAttr2.getEncoded());
            // System.out.println("signAttr2"+Hex.toHexString(signAttr2.getEncoded()));
            signature.update(Hex.decode("3169301806092a864886f70d010903310b06092a864886f70d010701301c06092a864886f70d010905310f170d3234303131363033333933395a302f06092a864886f70d010904312204201dfb90c25fc18f8291f5bb86b520886bc6589e0b3f3d38f74a6d49651eea934d"));
            // boolean verify = signature.verify(signValue.toASN1Primitive().getEncoded());
            System.out.println("signValue"+Hex.toHexString(signValue.toASN1Primitive().getEncoded()));
            boolean verify = signature.verify(Hex.decode("3046022100bc7c9c860e3cd52b21f2d88919d41aff0f47fb0029e8dfd7e53999fc95b814e4022100f3c72ddd2b10d3bebbf69e61a6dabd756aece1b6b3baed98cceca7d317622fba"));
            System.out.println("验签名值" + verify);

            // pdf
            MessageDigest messageDigest = DigestAlgorithms.getMessageDigest("SM3", "BC");

            // 签名原文
            byte[] updateData = new byte[(int) (longs[1] + longs[3])];
            System.arraycopy(pdfBytes, 0, updateData, 0, (int) longs[1]);
            System.arraycopy(pdfBytes, (int) longs[2], updateData, (int) longs[1], (int) longs[3]);
            FileUtil.writeBytes(updateData, "C:\\Users\\ggk911\\Desktop\\个人信息授权书range");
            ByteArrayInputStream input = new ByteArrayInputStream(updateData);
            byte[] buf = new byte[8192];
            int rd;
            while ((rd = input.read(buf, 0, buf.length)) > 0) {
                messageDigest.update(buf, 0, rd);
            }

            // 原文HASH
            byte[] digest1 = messageDigest.digest();
            System.out.println("原文哈希" + Hex.toHexString(digest1));

            // 原文哈希 equals 原文range摘要
            // System.out.println("原文哈希 equals 原文range摘要" + Hex.toHexString(digest1).equals(Hex.toHexString(digest.getOctets())));
            //
            // // 验时间戳签名值
            // Signature signature2 = Signature.getInstance("SM3withSM2", "BC");
            // CertificateFactory fact2 = CertificateFactory.getInstance("X.509", "BC");
            // X509Certificate cert4 = (X509Certificate) fact2.generateCertificate(new ByteArrayInputStream(timeCert.getEncoded()));
            // signature2.initVerify(cert4.getPublicKey());
            // signature2.update(timeStampAttr.getEncoded());
            // boolean verify2 = signature2.verify(timeStampSignValue.getEncoded());
            // System.out.println("验时间戳签名值" + verify2);


        }
    }
}
